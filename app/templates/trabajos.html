{% extends 'base.html' %}
{% block title %}Gestión de Trabajos{% endblock %}

{% block content %}
{% from "components/page_header.html" import page_header %}
{% from "components/form_fields.html" import text_field, phone_field, select_field, textarea_field %}
{% from "components/table.html" import paginated_table %}

<!-- Breadcrumb estilizado según la imagen -->
<div class="d-flex align-items-center mb-4 mt-3">
  <span class="fw-bold" style="color: #000; font-size: 20px;">Inicio</span>
  <span style="color: #888; margin: 0 8px; font-size: 20px;">/</span>
  <span class="fw-bold" style="color: #888; font-size: 20px;">Trabajos</span>
</div>

<!-- Botones de acción principales -->
<div class="d-flex gap-2 mb-4">
  <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newPresupuestoModal" style="border-radius: 1rem; border: 1px solid #cbc6c6; padding: 0.5rem 1.25rem; transition: all 0.3s ease;">
    <i class="bi bi-file-earmark-plus me-1"></i> Nuevo Presupuesto
  </button>
  <a href="{{ url_for('jobs.historial') }}" class="btn btn-outline-secondary" style="border-radius: 1rem; border: 1px solid #cbc6c6; padding: 0.5rem 1.25rem; transition: all 0.3s ease;">
    <i class="bi bi-clock-history me-1"></i> Ver Historial
  </a>
  <div class="ms-auto">
    <div class="input-group" style="border-radius: 1rem; overflow: hidden; border: 1px solid #cbc6c6;">
      <input type="text" class="form-control" placeholder="Buscar trabajo..." id="searchInput" style="border: none; border-radius: 1rem 0 0 1rem;">
      <button class="btn btn-outline-secondary" type="button" id="searchButton" style="border: none; background-color: #f8f9fa; border-radius: 0 1rem 1rem 0;">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
</div>

<!-- Formulario oculto para manejar los filtros -->
<form action="{{ url_for('jobs.trabajos') }}" method="GET" id="filtrosForm" style="display:none;">
  <input type="hidden" id="estado_oculto" name="estado" value="{{ request.args.get('estado', '') }}">
  <input type="hidden" id="fecha_inicio_oculto" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
  <input type="hidden" id="fecha_fin_oculto" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
</form>

<!-- Tarjeta de trabajos -->
<div class="card" style="border-radius: 1rem; border: 1px solid #cbc6c6; overflow: hidden;">  <div class="card-header d-flex align-items-center justify-content-between" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-list-task" style="font-size: 0.9rem; color: #6c757d;"></i>
      <span style="font-size: 0.9rem; color: #6c757d; font-weight: 500;">Trabajos Activos</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <!-- Filtro de Estado -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroEstadoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-funnel-fill me-1" style="color: #28a745;"></i>
          <span>Estado: {{ request.args.get('estado', 'Todos') }}</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end chart-period-menu" aria-labelledby="filtroEstadoDropdown">
          <li><a class="dropdown-item filter-estado" href="#" data-value=""><i class="bi bi-list-stars me-2"></i>Todos</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Pendiente"><i class="bi bi-hourglass me-2"></i>Pendiente</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="En Proceso"><i class="bi bi-gear-wide-connected me-2"></i>En Proceso</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Presupuesto"><i class="bi bi-file-earmark-text me-2"></i>Presupuesto</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Completado"><i class="bi bi-check-circle me-2"></i>Completado</a></li>
        </ul>
      </div>
      
      <!-- Filtro de Fecha Inicio -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroFechaInicioDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-event me-1" style="color: #28a745;"></i>
          <span>Desde: {{ request.args.get('fecha_inicio', 'Cualquier fecha') }}</span>
        </button>
        <div class="dropdown-menu p-3 dropdown-menu-end" style="min-width: 300px;" aria-labelledby="filtroFechaInicioDropdown">
          <div class="mb-2">Fecha Inicio:</div>
          <input type="date" class="form-control" id="fecha_inicio_filter" value="{{ request.args.get('fecha_inicio', '') }}">
          <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-sm btn-green aplicar-fecha-inicio">Aplicar</button>
          </div>
        </div>
      </div>
      
      <!-- Filtro de Fecha Fin -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroFechaFinDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-event-fill me-1" style="color: #28a745;"></i>
          <span>Hasta: {{ request.args.get('fecha_fin', 'Cualquier fecha') }}</span>
        </button>
        <div class="dropdown-menu p-3 dropdown-menu-end" style="min-width: 300px;" aria-labelledby="filtroFechaFinDropdown">
          <div class="mb-2">Fecha Fin:</div>
          <input type="date" class="form-control" id="fecha_fin_filter" value="{{ request.args.get('fecha_fin', '') }}">
          <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-sm btn-green aplicar-fecha-fin">Aplicar</button>
          </div>
        </div>
      </div>
        <!-- Botón para limpiar filtros -->
      <a href="{{ url_for('jobs.trabajos') }}" class="btn btn-sm btn-outline-secondary chart-period-btn" style="border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
        <i class="bi bi-arrow-repeat me-1" style="color: #28a745;"></i>
        <span>Limpiar filtros</span>
      </a>
    </div>
  </div>
  <div class="card-body p-0">
    {% if trabajos %}
    <div class="table-responsive">
      <table class="table mb-0 dashboard-table" id="trabajosTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Estado</th>
            <th>Técnico</th>
            <th>Descripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>          {% for trabajo in trabajos %}
          <tr data-estado="{{ trabajo.estado }}" data-id="{{ trabajo.id }}" class="trabajo-row" style="cursor: pointer;">
            <td class="text-center">
              <span class="text-decoration-none">
                Nº_{{ trabajo.id }}
              </span>
            </td>
            <td>{{ trabajo.nombre_cliente }} {{ trabajo.apellido_cliente or '' }}</td>
            <td>{{ trabajo.fecha.strftime('%d/%m/%Y') }}</td>
            <td>{{ trabajo.hora }}</td>
            <td>
              <span class="badge rounded-pill 
                {% if trabajo.estado == 'Presupuesto' %}bg-secondary
                {% elif trabajo.estado == 'Pendiente' %}bg-warning
                {% elif trabajo.estado == 'En Proceso' %}bg-primary
                {% elif trabajo.estado == 'Completado' %}bg-success
                {% else %}bg-secondary{% endif %}">
                {{ trabajo.estado }}
              </span>
            </td>
            <td>
              {% if trabajo.technician %}
                {{ trabajo.technician.nombre }} {{ trabajo.technician.apellido or '' }}
              {% else %}
                <span class="text-muted">Sin asignar</span>
              {% endif %}
            </td>
            <td>
              <div class="text-truncate" style="max-width: 150px;" title="{{ trabajo.descripcion }}">
                {{ trabajo.descripcion }}
              </div>
            </td>            <td>
              <div class="d-flex gap-1 justify-content-center">
                <!-- Botón para ver detalles -->
                <a href="{{ url_for('jobs.ver_trabajo', id=trabajo.id) }}" class="btn btn-sm btn-outline-secondary action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver detalles del trabajo">
                  <i class="bi bi-eye"></i>
                </a>
                
                <!-- Botón para aprobar presupuesto (solo si está en estado Presupuesto) -->
                {% if trabajo.estado == 'Presupuesto' %}
                <form method="POST" action="{{ url_for('jobs.aprobar_presupuesto', id=trabajo.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-success action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Aprobar presupuesto">
                    <i class="bi bi-check-circle"></i>
                  </button>
                </form>
                {% endif %}
                
                <!-- Botón para completar comprobante (solo si está En Proceso) -->
                {% if trabajo.estado == 'En Proceso' %}
                <a href="{{ url_for('jobs.completar_comprobante', id=trabajo.id) }}" class="btn btn-sm btn-info action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Completar comprobante de trabajo">
                  <i class="bi bi-file-earmark-text"></i>
                </a>
                {% endif %}                <!-- Botón para editar -->
                <button class="btn btn-sm btn-warning editar-trabajo action-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editJobModal"
                        data-id="{{ trabajo.id }}"
                        data-nombre_cliente="{{ trabajo.nombre_cliente }}"
                        data-apellido_cliente="{{ trabajo.apellido_cliente }}"
                        data-telefono="{{ trabajo.telefono }}"
                        data-direccion="{{ trabajo.direccion }}"
                        data-codigo_postal="{{ trabajo.codigo_postal }}"
                        data-descripcion="{{ trabajo.descripcion }}"
                        data-duracion="{{ trabajo.duracion }}"
                        data-fecha="{{ trabajo.fecha.strftime('%Y-%m-%d') }}"
                        data-hora="{{ trabajo.hora }}"
                        data-tecnico_id="{{ trabajo.technician_id or '' }}"
                        data-estado="{{ trabajo.estado }}"
                        data-cantidad="{{ trabajo.cantidad or '' }}"
                        data-bs-custom-class="tooltip-warning"
                        title="Editar trabajo">
                  <i class="bi bi-pencil-square"></i>
                </button>
                  <!-- Botón para eliminar -->
                <button class="btn btn-sm btn-danger confirm-delete-job action-btn"
                        data-id="{{ trabajo.id }}"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-bs-custom-class="tooltip-danger"
                        title="Eliminar trabajo">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Paginación -->
    <div class="d-flex justify-content-center" style="padding: 10px 0; margin-top: -1px; border-top: 1px solid #cbc6c6; background-color: #f9f9f9; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
      <nav aria-label="Paginación de trabajos">
        <ul class="pagination m-0" style="gap: 0.5rem;">
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">&laquo;</span>
          </li>
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">&lt;</span>
          </li>
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">1 / 3</span>
          </li>
          <li class="page-item">
            <a class="page-link minimal-pagination" href="#">&gt;</a>
          </li>
          <li class="page-item">
            <a class="page-link minimal-pagination" href="#">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>
    
    {% else %}
    <div class="alert alert-info m-3 text-center">
      <i class="bi bi-info-circle me-2"></i> No hay trabajos registrados.
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal para nuevo presupuesto -->
<div class="modal fade" id="newPresupuestoModal" tabindex="-1" aria-labelledby="newPresupuestoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xxl modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; overflow: hidden;">
      <div class="modal-header" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6;">
        <h5 class="modal-title" id="newPresupuestoModalLabel">
          <i class="bi bi-file-earmark-plus me-2 text-green"></i>Crear Nuevo Presupuesto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('jobs.crear_presupuesto') }}" id="addBudgetForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <!-- Sección de Datos de Cliente -->
          <div class="mb-4">
            <h6 class="fw-bold text-green mb-3"><i class="bi bi-person me-2"></i>Datos del Cliente</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-3">
                {{ text_field("nombre_cliente", "Nombre:", "Ingrese el nombre del cliente", required=true) }}
              </div>
              <div class="col-md-3">
                {{ text_field("apellido_cliente", "Apellido:", "Ingrese el apellido del cliente", required=true) }}
              </div>
              <div class="col-md-3">
                {{ phone_field("telefono", "Teléfono:", "Ingrese el teléfono del cliente", required=true) }}
              </div>
              <div class="col-md-3">
                {{ text_field("email", "Correo Electrónico:", "Ingrese el correo electrónico", required=true) }}
              </div>
            </div>
            
            <div class="row g-3 mb-1">
              <div class="col-md-3">
                <label for="dni_cif" class="form-label">DNI/NIE/CIF:</label>
                <input type="text" class="form-control" id="dni_cif" name="dni_cif" placeholder="Para facturación" style="border-radius: 0.5rem;">
                <div class="form-text small">
                  <i class="bi bi-info-circle me-1 text-green"></i>Necesario para facturación
                </div>
              </div>
              <div class="col-md-2">
                <label for="tipo_documento" class="form-label">Tipo de documento:</label>
                <select class="form-select" id="tipo_documento" name="tipo_documento" style="border-radius: 0.5rem;">
                  <option value="dni">DNI</option>
                  <option value="nie">NIE</option>
                  <option value="cif">CIF</option>
                </select>
              </div>
              <div class="col-md-5">
                <label for="direccion" class="form-label">Dirección:</label>
                <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Ingrese la dirección" style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-2">
                <label for="codigo_postal" class="form-label">Código Postal:</label>
                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" placeholder="C.P." style="border-radius: 0.5rem;">
              </div>
            </div>
          </div>
          
          <!-- Sección de Detalles del Trabajo -->
          <div class="mb-4">
            <h6 class="fw-bold text-green mb-3"><i class="bi bi-tools me-2"></i>Detalles del Trabajo</h6>
            <div class="row mb-3">
              <div class="col-md-8">
                {{ textarea_field("descripcion", "Descripción del Trabajo:", "Ingrese una descripción detallada del trabajo a realizar...", rows=3, required=true) }}
              </div>
              <div class="col-md-4">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="fecha" class="form-label">Fecha Programada:</label>
                    <input type="date" class="form-control" id="fecha" name="fecha" style="border-radius: 0.5rem;">
                    <div class="form-text small">
                      <i class="bi bi-calendar3 me-1 text-green"></i>Opcional
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="hora" class="form-label">Hora:</label>
                    <input type="time" class="form-control" id="hora" name="hora" style="border-radius: 0.5rem;">
                    <div class="form-text small">
                      <i class="bi bi-clock me-1 text-green"></i>Opcional
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label for="duracion" class="form-label">Duración Estimada:</label>
                    <select class="form-select" id="duracion" name="duracion" style="border-radius: 0.5rem;" required>
                      <option value="corta">Corta (1 hora)</option>
                      <option value="media" selected>Media (2 horas)</option>
                      <option value="larga">Larga (3 horas)</option>
                    </select>
                  </div>
                  <div class="col-md-12">
                    <label for="cantidad" class="form-label">Importe Total (€):</label>
                    <div class="input-group" style="border-radius: 0.5rem; overflow: hidden;">
                      <input type="number" class="form-control" id="cantidad" name="cantidad" step="0.01" min="0" placeholder="0.00" required style="border-radius: 0.5rem 0 0 0.5rem;">
                      <span class="input-group-text" style="border-radius: 0 0.5rem 0.5rem 0;">€</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 1rem; padding: 0.5rem 1.25rem; transition: all 0.3s ease; border: 1px solid #cbc6c6;">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-green" id="submitPresupuesto" style="border-radius: 1rem; border: 1px solid #28a745; padding: 0.5rem 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: all 0.3s ease;">
            <i class="bi bi-file-earmark-plus me-1"></i><span id="submitText">Generar y Enviar Presupuesto</span>
            <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar trabajo -->
<div class="modal fade" id="editJobModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <form id="editJobForm" method="POST" action="" class="needs-validation" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="modal-content" style="border-radius: 1rem; overflow: hidden;">
        <div class="modal-header" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6;">
          <h5 class="modal-title" id="editJobModalLabel">
            <i class="bi bi-pencil-square me-2"></i>Editar Trabajo
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Datos del Cliente -->
          <div class="mb-4">
            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person me-2"></i>Datos del Cliente</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label for="modalNombreCliente" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="modalNombreCliente" name="nombre_cliente" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-4">
                <label for="modalApellidoCliente" class="form-label">Apellido</label>
                <input type="text" class="form-control" id="modalApellidoCliente" name="apellido_cliente" style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-4">
                <label for="modalTelefono" class="form-label">Teléfono</label>
                <input type="text" class="form-control" id="modalTelefono" name="telefono"
                      pattern="^(?:\+34[\s-]?)?(?:\d{3}[\s.-]?\d{3}[\s.-]?\d{3})$"
                      title="Formato de teléfono español inválido. Ej: +34 123456789 o 123-456-789"
                      maxlength="15" style="border-radius: 0.5rem;">
                <div id="telefono-error" class="invalid-feedback">
                  Formato de teléfono inválido
                </div>
              </div>
            </div>
            
            <div class="row g-3 mb-3">
              <div class="col-md-8">
                <label for="modalDireccion" class="form-label">Dirección</label>
                <input type="text" class="form-control" id="modalDireccion" name="direccion" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-4">
                <label for="modalCodigoPostal" class="form-label">Código Postal</label>
                <input type="text" class="form-control" id="modalCodigoPostal" name="codigo_postal" style="border-radius: 0.5rem;">
              </div>
            </div>
          </div>
          
          <!-- Detalles del Trabajo -->
          <div class="mb-4">
            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-tools me-2"></i>Detalles del Trabajo</h6>
            <div class="mb-3">
              <label for="modalDescripcion" class="form-label">Descripción</label>
              <textarea class="form-control" id="modalDescripcion" name="descripcion" rows="3" required style="border-radius: 0.5rem;"></textarea>
            </div>
          
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label for="modalFecha" class="form-label">Fecha</label>
                <input type="date" class="form-control" id="modalFecha" name="fecha" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-4">
                <label for="modalHora" class="form-label">Hora</label>
                <input type="time" class="form-control" id="modalHora" name="hora" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-md-4">
                <label for="modalDuracion" class="form-label">Duración Estimada</label>
                <select class="form-select" id="modalDuracion" name="duracion" style="border-radius: 0.5rem;">
                  <option value="corta">Corta (1 hora)</option>
                  <option value="media">Media (2 horas)</option>
                  <option value="larga">Larga (3 horas)</option>
                </select>
              </div>
            </div>
  
            <div class="row g-3 mb-3">              <div class="col-md-6">                <label for="modalTecnicoId" class="form-label">Técnico Asignado</label>
                <select class="form-select" id="modalTecnicoId" name="tecnico_id" style="border-radius: 0.5rem;">
                  <option value="">Sin asignar</option>
                  {% for tecnico in tecnicos %}
                  <option value="{{ tecnico.id }}">
                    {{ tecnico.nombre }} {% if tecnico.apellido %}{{ tecnico.apellido }}{% endif %}
                  </option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">
                  {% if tecnicos %}
                    Solo se muestran técnicos disponibles.
                  {% else %}
                    <span class="text-warning">No hay técnicos disponibles en este momento.</span>
                  {% endif %}
                </small>
              </div>
              <div class="col-md-6">
                <label for="modalEstado" class="form-label">Estado del Trabajo</label>
                <select class="form-select" id="modalEstado" name="estado" style="border-radius: 0.5rem;">
                  <option value="Presupuesto">Presupuesto</option>
                  <option value="Pendiente">Pendiente</option>
                  <option value="En Proceso">En Proceso</option>
                  <option value="Completado">Completado</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Importe -->
          <div class="mb-4">
            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-currency-euro me-2"></i>Importe</h6>
            <div class="row">
              <div class="col-md-6">
                <label for="modalCantidad" class="form-label">Importe (€)</label>
                <div class="input-group" style="border-radius: 0.5rem; overflow: hidden;">
                  <input type="number" class="form-control" id="modalCantidad" name="cantidad" step="0.01" min="0" style="border-radius: 0.5rem 0 0 0.5rem;">
                  <span class="input-group-text" style="border-radius: 0 0.5rem 0.5rem 0;">€</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 1rem; padding: 0.5rem 1.25rem; transition: all 0.3s ease; border: 1px solid #cbc6c6;">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-third" id="editJobSubmit" style="border-radius: 1rem; border: 1px solid #cbc6c6; padding: 0.5rem 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: all 0.3s ease;">
            <i class="bi bi-save me-1"></i><span>Guardar Cambios</span>
            <span id="editLoadingSpinner" class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar eliminación de trabajo -->
{% from "components/modals.html" import confirm_modal %}

{{ confirm_modal(
    id="confirmDeleteModal",
    title="Confirmar Eliminación",
    message="¿Estás seguro de que deseas eliminar este trabajo? Esta acción no se puede deshacer.",
    action_url="",
    confirm_text="Eliminar",
    cancel_text="Cancelar"
) }}
{% endblock %}

{% block extra_scripts %}
<script>  document.addEventListener('DOMContentLoaded', function() {
    // Añadir atributos para tooltips a los botones que no los tienen
    document.querySelectorAll('.action-btn').forEach(function(btn) {
      if (!btn.getAttribute('title')) {
        // Determinar el tipo de botón por su icono o clase
        if (btn.querySelector('.bi-eye')) {
          btn.setAttribute('title', 'Ver detalles del trabajo');
        } else if (btn.querySelector('.bi-pencil-square')) {
          btn.setAttribute('title', 'Editar trabajo');
        } else if (btn.querySelector('.bi-trash')) {
          btn.setAttribute('title', 'Eliminar trabajo');
        } else if (btn.querySelector('.bi-check-circle')) {
          btn.setAttribute('title', 'Aprobar presupuesto');
        } else if (btn.querySelector('.bi-file-earmark-text')) {
          btn.setAttribute('title', 'Completar comprobante de trabajo');
        }
      }
    });
    
    // Inicializar tooltips para todos los elementos con título
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('.action-btn[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl, {
        trigger: 'hover',
        placement: 'top',
        delay: { show: 300, hide: 100 }
      });
    });
    
    // Configuración del formulario de presupuesto
    const addBudgetForm = document.getElementById('addBudgetForm');
    if (addBudgetForm) {
      addBudgetForm.addEventListener('submit', function(e) {
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        
        // Si uno está lleno y el otro vacío, solicitar completar ambos
        if ((fechaInput.value && !horaInput.value) || (!fechaInput.value && horaInput.value)) {
          e.preventDefault();
          alert('Por favor, complete tanto la fecha como la hora, o deje ambos campos vacíos para asignación automática.');
          return;
        }
        
        // Mostrar animación de carga
        const submitButton = document.getElementById('submitPresupuesto');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const submitText = document.getElementById('submitText');
        
        if (submitButton && loadingSpinner && submitText) {
          submitButton.disabled = true;
          loadingSpinner.style.display = 'inline-block';
          submitText.textContent = 'Procesando...';
        }
      });
    }
    
    // Configuración del formulario de edición de trabajo
    const editJobForm = document.getElementById('editJobForm');
    if (editJobForm) {
      editJobForm.addEventListener('submit', function(e) {
        const submitButton = document.getElementById('editJobSubmit');
        const loadingSpinner = document.getElementById('editLoadingSpinner');
        
        if (submitButton && loadingSpinner) {
          submitButton.disabled = true;
          loadingSpinner.style.display = 'inline-block';
          submitButton.querySelector('span').textContent = 'Guardando...';
        }
      });
    }
    
    // Configurar modal de eliminación
    const deleteButtons = document.querySelectorAll('.confirm-delete-job');
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        const jobId = this.getAttribute('data-id');
        const form = document.querySelector('#confirmDeleteModal form');
        form.action = `{{ url_for('jobs.eliminar_trabajo', id=0) }}`.replace('0', jobId);
      });
    });
      // Manejo de filtros en la cabecera
    const filtrosForm = document.getElementById('filtrosForm');
    const estadoOcultoInput = document.getElementById('estado_oculto');
    const fechaInicioOcultoInput = document.getElementById('fecha_inicio_oculto');
    const fechaFinOcultoInput = document.getElementById('fecha_fin_oculto');
    
    // Filtrado por estado con nuevo dropdown
    document.querySelectorAll('.filter-estado').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const estadoValor = this.getAttribute('data-value');
        
        // Actualizar campo oculto
        estadoOcultoInput.value = estadoValor;
        
        // Enviar formulario automáticamente
        filtrosForm.submit();
      });
    });
    
    // Filtrado por fecha de inicio
    document.querySelector('.aplicar-fecha-inicio').addEventListener('click', function() {
      const fechaInicioValor = document.getElementById('fecha_inicio_filter').value;
      
      // Actualizar campo oculto
      fechaInicioOcultoInput.value = fechaInicioValor;
      
      // Enviar formulario automáticamente
      filtrosForm.submit();
    });
    
    // Filtrado por fecha de fin
    document.querySelector('.aplicar-fecha-fin').addEventListener('click', function() {
      const fechaFinValor = document.getElementById('fecha_fin_filter').value;
      
      // Actualizar campo oculto
      fechaFinOcultoInput.value = fechaFinValor;
      
      // Enviar formulario automáticamente
      filtrosForm.submit();
    });
    
    // Función de búsqueda
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    
    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase();
      const rows = document.querySelectorAll('#trabajosTable tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    if (searchButton && searchInput) {
      searchButton.addEventListener('click', performSearch);
      searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }
    
    // Inicializar paginación
    // Código para paginar la tabla (15 trabajos por página)
    const table = document.getElementById('trabajosTable');
    if (table) {
      const rowsPerPage = 15;
      const rows = table.querySelectorAll('tbody tr');
      const pageCount = Math.ceil(rows.length / rowsPerPage);
      
      // Función para mostrar una página específica
      function showPage(pageNumber) {
        // Ocultar todas las filas
        rows.forEach(row => {
          row.style.display = 'none';
        });
        
        // Mostrar las filas de la página actual
        const start = (pageNumber - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        
        for (let i = start; i < end && i < rows.length; i++) {
          rows[i].style.display = '';
        }
        
        // Actualizar navegación de paginación
        updatePagination(pageNumber);
      }
      
      // Función para actualizar los controles de paginación
      function updatePagination(currentPage) {
        const pagination = document.querySelector('.pagination');
        if (pagination) {
          const pageLinks = pagination.querySelectorAll('span.page-link');
          if (pageLinks && pageLinks.length > 0) {
            const pageInfoSpan = pageLinks[2]; // El tercero es el que contiene la información de la página
            pageInfoSpan.textContent = `${currentPage} / ${pageCount}`;
          }
          
          // Actualizar estado de los botones siguiente/anterior
          const prevButton = pagination.querySelector('.page-item:nth-child(2)');
          const nextButton = pagination.querySelector('.page-item:nth-child(4)');
          
          if (prevButton) {
            if (currentPage <= 1) {
              prevButton.classList.add('disabled');
            } else {
              prevButton.classList.remove('disabled');
              const prevLink = prevButton.querySelector('a, span');
              if (prevLink.tagName === 'A') {
                prevLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(currentPage - 1);
                };
              }
            }
          }
          
          if (nextButton) {
            if (currentPage >= pageCount) {
              nextButton.classList.add('disabled');
            } else {
              nextButton.classList.remove('disabled');
              const nextLink = nextButton.querySelector('a, span');
              if (nextLink.tagName === 'A') {
                nextLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(currentPage + 1);
                };
              }
            }
          }
          
          // Actualizar primer y último botón
          const firstButton = pagination.querySelector('.page-item:first-child');
          const lastButton = pagination.querySelector('.page-item:last-child');
          
          if (firstButton) {
            if (currentPage <= 1) {
              firstButton.classList.add('disabled');
            } else {
              firstButton.classList.remove('disabled');
              const firstLink = firstButton.querySelector('a, span');
              if (firstLink.tagName === 'A') {
                firstLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(1);
                };
              }
            }
          }
          
          if (lastButton) {
            if (currentPage >= pageCount) {
              lastButton.classList.add('disabled');
            } else {
              lastButton.classList.remove('disabled');
              const lastLink = lastButton.querySelector('a, span');
              if (lastLink.tagName === 'A') {
                lastLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(pageCount);
                };
              }
            }
          }
        }
      }
      
      // Si hay más de una página, inicializar la paginación
      if (pageCount > 1) {
        showPage(1);
        
        // Actualizar navegación inicial
        const pagination = document.querySelector('.pagination');
        if (pagination) {
          const pageLinks = pagination.querySelectorAll('.page-link');
          
          // Configurar los botones de navegación
          if (pageLinks.length >= 5) {
            pageLinks[0].onclick = function(e) {
              e.preventDefault();
              showPage(1);
            };
            
            pageLinks[1].onclick = function(e) {
              e.preventDefault();
              const currentPage = parseInt(pageLinks[2].textContent.split(' / ')[0]);
              if (currentPage > 1) {
                showPage(currentPage - 1);
              }
            };
            
            pageLinks[3].onclick = function(e) {
              e.preventDefault();
              const currentPage = parseInt(pageLinks[2].textContent.split(' / ')[0]);
              if (currentPage < pageCount) {
                showPage(currentPage + 1);
              }
            };
            
            pageLinks[4].onclick = function(e) {
              e.preventDefault();
              showPage(pageCount);
            };
          }
        }
      }
    }
  });
</script>

<style>
  /* Estilo para los inputs y selects */
  .form-control, .form-select {
    border-radius: 0.5rem !important;
    border: 1px solid #cbc6c6;
  }
  
  /* Estilo para los botones con clase btn-third */
  .btn-third {
    background-color: #6772E5;
    color: white;
    transition: all 0.3s ease;
  }
  
  /* Estilo para las esquinas de elementos de formulario con clase form-control y form-select */
  .input-group .form-control:first-child {
    border-top-left-radius: 0.5rem !important;
    border-bottom-left-radius: 0.5rem !important;
  }
  
  .input-group .input-group-text:last-child {
    border-top-right-radius: 0.5rem !important;
    border-bottom-right-radius: 0.5rem !important;
  }
  
  /* Mejoras visuales para los modales */
  .modal-content {
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .modal-header {
    border-bottom-color: #f0f0f0;
  }
  
  .modal-footer {
    border-top-color: #f0f0f0;
  }
  
  /* Estilo para la barra de búsqueda */
  .input-group {
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  /* Eliminar el borde verde al seleccionar la caja de búsqueda */
  #searchInput:focus {
    box-shadow: none !important;
    border-color: #cbc6c6 !important;
    outline: none !important;
  }
  
  /* Estilo hover para el botón de búsqueda */
  #searchButton:hover {
    background-color: rgba(40, 167, 69, 0.1) !important;
    color: #28a745 !important;
    transition: all 0.2s ease;
  }
  
  #searchButton:hover i.bi-search {
    transform: scale(1.1);
    color: #28a745;
    transition: all 0.2s ease;
  }
  
  /* Asegurar que las migas de pan estén en negrita */
  .breadcrumb-item {
    font-weight: bold !important;
  }
    /* Estilos para el dropdown del filtro de trabajos */
  .chart-filter-dropdown {
    position: relative;
  }

  .chart-filter-dropdown .dropdown-menu {
    box-shadow: 0 5px 15px rgba(0,0,0,.1);
    border: none;
    animation: fadeIn 0.3s ease-in-out;
    padding: 0.5rem 0;
    position: absolute;
    right: 0;
    left: auto;
    top: 100%;
    transform: none !important;
    margin-top: 0.5rem;
    min-width: 200px;
    border-radius: 0.75rem;
  }
  
  .chart-period-btn {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem !important;
    color: #6c757d;
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
  }
  
  .chart-period-btn:hover {
    background-color: #e9ecef;
    color: #495057;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-color: #28a745;
  }
  
  .chart-period-menu .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    color: #6c757d;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .chart-period-menu .dropdown-item:hover {
    background-color: rgba(40, 167, 69, 0.1); /* Verde claro igual que en dashboard */
    color: #495057;
  }
  
  .chart-period-menu .dropdown-item:active {
    background-color: #28a745; /* Verde para estado activo */
    color: white;
  }
  
  .chart-period-menu .dropdown-item i {
    color: #28a745; /* Verde para los iconos */
    width: 1.2rem;
    text-align: center;
    transition: all 0.2s ease;
  }
  
  .chart-period-menu .dropdown-item:hover i {
    transform: scale(1.1);
  }
  
  /* Estilos específicos para los filtros de fecha en el dropdown */
  .chart-filter-dropdown .dropdown-menu.p-3 {
    padding: 1rem !important;
    border-radius: 0.75rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  }
  
  #fecha_inicio_filter, #fecha_fin_filter {
    border-radius: 0.5rem;
    border: 1px solid #cbc6c6;
  }
  
  .btn-green {
    border-radius: 0.5rem;
    font-size: 0.85rem;
    padding: 0.25rem 0.75rem;
  }
  
  /* Estilos para la paginación minimalista como en el dashboard */
  .minimal-pagination {
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem !important;
    border: 1px solid #e9ecef;
    color: #6c757d;
    font-size: 0.85rem;
    background-color: #f8f9fa;
    min-width: 32px;
    text-align: center;
    margin: 0;
    transition: all 0.2s ease;
  }
  
  .minimal-pagination:hover:not(.disabled) {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
    border-color: #28a745;
    transform: translateY(-1px);
  }
  
  .pagination {
    gap: 0.35rem;
  }
  
  .page-item.disabled .minimal-pagination {
    opacity: 0.6;
    pointer-events: none;
  }
  
  /* Estilo para los botones principales de acción */
  .btn-outline-secondary:hover {
    background-color: rgba(40, 167, 69, 0.1) !important;
    color: #28a745 !important;
    border-color: #28a745 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
  }
  
  /* Estilos para el modal con tema verde */
  .text-green {
    color: #28a745 !important;
  }
  
  .btn-green {
    background-color: #28a745 !important;
    color: white !important;
    transition: all 0.3s ease;
  }
  
  .btn-green:hover {
    background-color: #218838 !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
  }
  
  /* Definición de modal extra grande */
  .modal-xxl {
    max-width: 95%;
    width: 1400px;
    margin-left: 125px; /* Desplazar a la derecha para centrarlo en el área de contenido */
  }
  
  /* Ajuste para centrar el modal en la zona de contenido */
  @media (min-width: 992px) {
    .modal-dialog.modal-xxl {
      margin-right: auto;
      margin-left: 255px; /* Ajustar para compensar el ancho del sidebar */
      max-width: calc(95% - 130px); /* Reducir un poco el ancho para compensar el espacio del sidebar */
    }
  }
  
  /* Ajuste para pantallas muy grandes */
  @media (min-width: 1400px) {
    .modal-dialog.modal-xxl {
      margin-left: 275px; /* Ajuste para pantallas grandes */
      max-width: calc(95% - 150px);
    }
  }
  
  /* Ajuste para pantallas pequeñas */
  @media (max-width: 991.98px) {
    .modal-dialog.modal-xxl {
      margin-left: auto; /* En pantallas pequeñas, centrado normal */
      margin-right: auto;
      max-width: 95%;
    }
  }
    .form-control:focus, .form-select:focus {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
    /* Estilos para centrar los iconos en los botones de acción */
  .action-btn {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 32px;
    height: 32px;
    padding: 0 !important;
    transition: all 0.2s ease;
    margin: 0 2px;
  }
  
  .action-btn i {
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 0; /* Eliminar márgenes del icono */
  }
  
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }
    /* Asegurar que los botones dentro de forms también estén centrados */
  form .action-btn {
    margin: 0 auto;
  }
  
  /* Estilos para los tooltips personalizados */
  .tooltip {
    font-size: 0.8rem;
    opacity: 0.95 !important;
  }
  
  .tooltip-inner {
    padding: 0.4rem 0.8rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    max-width: 200px;
  }
  
  .tooltip-warning .tooltip-inner {
    background-color: #ffc107;
    color: #212529;
  }
  
  .tooltip-danger .tooltip-inner {
    background-color: #dc3545;
  }
  
  .bs-tooltip-top .tooltip-arrow::before {
    border-top-color: inherit;
  }
  
  /* Ajuste adicional para el contenedor de botones de acciones */
  td .d-flex.gap-1.justify-content-center {
    display: inline-flex !important;
    min-width: 120px; /* Ancho mínimo para que quepan los 3 botones */  }
</style>

<!-- Script para hacer las filas de la tabla clickeables -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Agregar estilo CSS para filas clickeables
    const style = document.createElement('style');
    style.textContent = `
      .trabajo-row {
        transition: background-color 0.15s ease-in-out;
      }
      .trabajo-row:hover {
        background-color: rgba(67, 171, 1, 0.05);
      }
    `;
    document.head.appendChild(style);
      // Hacer que las filas de la tabla sean clickeables
    document.querySelectorAll('.trabajo-row').forEach(row => {
      row.addEventListener('click', function(e) {
        // Evitar que el clic funcione si se hace en un botón o enlace dentro de la fila
        if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) {
          return;
        }
        
        // Obtener el ID del trabajo desde el atributo data-id
        const trabajoId = this.getAttribute('data-id');
        // Redirigir a la página de detalles del trabajo
        if (trabajoId) {
          window.location.href = '/jobs/' + trabajoId;
        }
      });
    });
  });
</script>
{% endblock %}
