{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <!-- Caja de Añadir Trabajo -->
  <div class="card mb-4">
    <div class="card-header" style="background-color: var(--header-bg) !important; color: var(--button-text) !important;">
      <h4 class="mb-0">Añadir Trabajo</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('jobs.crear_trabajo') }}">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="nombre_cliente" class="form-label">Nombre del Cliente:</label>
            <input type="text" class="form-control trabajo-input" id="nombre_cliente" name="nombre_cliente" placeholder="Ingrese el nombre del cliente" required>
          </div>
          <div class="col-md-6">
            <label for="apellido_cliente" class="form-label">Apellido del cliente:</label>
            <input type="text" class="form-control trabajo-input" id="apellido_cliente" name="apellido_cliente" placeholder="Ingrese el apellido del cliente">
          </div>
        </div>
        <div class="mb-3">
          <label for="telefono" class="form-label">Teléfono del cliente:</label>
          <input type="text" class="form-control trabajo-input" id="telefono" name="telefono" placeholder="Ingrese el teléfono del cliente"
                 pattern="^(?:\+34[\s-]?)?(?:\d{3}[\s.-]?\d{3}[\s.-]?\d{3})$"
                 title="Formato de teléfono español inválido. Ej: +34 123456789 o 123-456-789"
                 maxlength="15">
        </div>
        <div class="mb-3">
          <label for="direccion" class="form-label">Dirección (Calle, número, etc.):</label>
          <input type="text" class="form-control trabajo-input" id="direccion" name="direccion" placeholder="Ingrese la dirección" required>
        </div>
        <div class="mb-3">
          <label for="codigo_postal" class="form-label">Código Postal:</label>
          <input type="text" class="form-control trabajo-input" id="codigo_postal" name="codigo_postal" placeholder="Ingrese el código postal">
        </div>
        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripción del trabajo:</label>
          <textarea class="form-control" id="descripcion" name="descripcion" rows="2" placeholder="Ingrese una descripción…" required></textarea>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="duracion" class="form-label">Duración:</label>
            <select class="form-select trabajo-input" id="duracion" name="duracion" required>
              <option value="corta">Corta (1 hora)</option>
              <option value="media" selected>Media (2 horas)</option>
              <option value="larga">Larga (3 horas)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="fecha" class="form-label">Fecha:</label>
            <input type="date" class="form-control trabajo-input" id="fecha" name="fecha" required>
          </div>
          <div class="col-md-4">
            <label for="hora" class="form-label">Hora:</label>
            <input type="time" class="form-control trabajo-input" id="hora" name="hora" required>
          </div>
        </div>
        <button type="submit" class="btn btn-third">Crear trabajo</button>
      </form>
    </div>
  </div>

  <!-- Listado de Trabajos -->
  {% if trabajos %}
    <div class="table-responsive">
      <table class="table table-striped table-hover trabajos-table">
        <thead class="thead-dark">
          <tr>
            <th>Cliente</th>
            <th class="text-center">Teléfono</th>
            <th>Dirección</th>
            <th>Descripción</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Técnico</th>
            <th class="text-center">Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for trabajo in trabajos %}
          <tr>
            <td title="{{ trabajo.nombre_cliente }}{% if trabajo.apellido_cliente %} {{ trabajo.apellido_cliente }}{% endif %}">
              {{ trabajo.nombre_cliente }}{% if trabajo.apellido_cliente %} {{ trabajo.apellido_cliente }}{% endif %}
            </td>
            <td class="text-center" title="{{ trabajo.telefono }}">{{ trabajo.telefono }}</td>
            <td title="{{ trabajo.direccion }}">{{ trabajo.direccion }}</td>
            <td title="{{ trabajo.descripcion }}">{{ trabajo.descripcion }}</td>
            <td title="{{ trabajo.fecha.strftime('%Y-%m-%d') if trabajo.fecha else '' }}">
              {{ trabajo.fecha.strftime('%Y-%m-%d') if trabajo.fecha else '' }}
            </td>
            <td title="{{ trabajo.hora }}">{{ trabajo.hora }}</td>
            <td>
              {% if trabajo.technician_id %}
                {% for tecnico in tecnicos %}
                  {% if tecnico.id == trabajo.technician_id %}
                    {{ tecnico.nombre }}{% if tecnico.apellido %} {{ tecnico.apellido }}{% endif %}
                  {% endif %}
                {% endfor %}
              {% else %}
                Sin asignar
              {% endif %}
            </td>
            <td class="text-center">
              {% if trabajo.technician_id and trabajo.estado == 'Pendiente' %}
                En proceso
              {% else %}
                {{ trabajo.estado }}
              {% endif %}
            </td>
            <td class="text-center">
              <div class="d-flex justify-content-center align-items-center">
                <button class="btn btn-warning btn-sm btn-action editar-trabajo" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editJobModal"
                        data-id="{{ trabajo.id }}"
                        data-nombre_cliente="{{ trabajo.nombre_cliente }}"
                        data-apellido_cliente="{{ trabajo.apellido_cliente }}"
                        data-direccion="{{ trabajo.direccion }}"
                        data-fecha="{{ trabajo.fecha.strftime('%Y-%m-%d') }}"
                        data-descripcion="{{ trabajo.descripcion }}"
                        data-telefono="{{ trabajo.telefono }}"
                        data-codigo_postal="{{ trabajo.codigo_postal }}"
                        data-hora="{{ trabajo.hora }}"
                        data-tecnico-id="{{ trabajo.technician_id }}"
                        data-estado="{{ trabajo.estado }}">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-danger btn-sm btn-action confirm-delete-job" 
                        data-job-id="{{ trabajo.id }}"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal">
                  <i class="bi bi-trash-fill"></i>
                </button>
                {% if trabajo.technician_id and trabajo.estado != 'Completado' %}
                <button class="btn btn-success btn-sm btn-action confirm-complete-job" 
                        data-job-id="{{ trabajo.id }}"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmCompleteModal">
                  <i class="bi bi-check-circle"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info persistent-alert text-center">
      <i class="bi bi-info-circle"></i> No hay trabajos registrados.
    </div>
  {% endif %}
</div>
<!-- Modal para editar trabajo -->
<div class="modal fade" id="editJobModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="editJobForm" method="POST" action="">
      <div class="modal-content modal-rectangular">
        <div class="modal-header">
          <h5 class="modal-title" id="editJobModalLabel">Editar Trabajo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="modalNombreCliente" class="form-label">Nombre del Cliente</label>
              <input type="text" class="form-control" id="modalNombreCliente" name="nombre_cliente" required>
            </div>
            <div class="col-md-6">
              <label for="modalApellidoCliente" class="form-label">Apellido del Cliente</label>
              <input type="text" class="form-control" id="modalApellidoCliente" name="apellido_cliente">
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="modalDireccion" class="form-label">Dirección</label>
              <input type="text" class="form-control" id="modalDireccion" name="direccion" required>
            </div>
            <div class="col-md-6">
              <label for="modalFecha" class="form-label">Fecha</label>
              <input type="date" class="form-control" id="modalFecha" name="fecha" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalDescripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="modalDescripcion" name="descripcion" rows="2" required></textarea>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="modalTelefono" class="form-label">Teléfono</label>
              <input type="text" class="form-control" id="modalTelefono" name="telefono">
            </div>
            <div class="col-md-6">
              <label for="modalCodigoPostal" class="form-label">Código Postal</label>
              <input type="text" class="form-control" id="modalCodigoPostal" name="codigo_postal">
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="modalDuracion" class="form-label">Duración</label>
              <select class="form-select" id="modalDuracion" name="duracion">
                <option value="corta">Corta</option>
                <option value="media">Media</option>
                <option value="larga">Larga</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="modalHora" class="form-label">Hora</label>
              <input type="time" class="form-control" id="modalHora" name="hora" required>
            </div>
            <div class="col-md-4">
              <label for="modalTecnicoId" class="form-label">Técnico Asignado</label>
              <select class="form-select" id="modalTecnicoId" name="tecnico_id">
                {% for tecnico in tecnicos %}
                  <option value="{{ tecnico.id }}">{{ tecnico.nombre }}{% if tecnico.apellido %} {{ tecnico.apellido }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalEstado" class="form-label">Estado</label>
            <select class="form-select" id="modalEstado" name="estado">
              <option value="Pendiente">Pendiente</option>
              <option value="En Proceso">En Proceso</option>
              <option value="Completado">Completado</option>
            </select>
          </div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="deleteJobForm" method="POST" action="">
      <div class="modal-content modal-rectangular">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas eliminar este trabajo?
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar completado -->
<div class="modal fade" id="confirmCompleteModal" tabindex="-1" aria-labelledby="confirmCompleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="completeJobForm" method="POST" action="">
      <div class="modal-content modal-rectangular">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmCompleteModalLabel">Marcar como Completado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Deseas marcar este trabajo como completado?
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Confirmar</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}
