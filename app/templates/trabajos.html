{% extends 'base.html' %}
{% block title %}Gestión de Trabajos{% endblock %}

{% block content %}
{% from "components/page_header.html" import page_header %}
{% from "components/form_fields.html" import text_field, phone_field, select_field, textarea_field %}
{% from "components/table.html" import paginated_table %}

<!-- Breadcrumb estilizado según la imagen -->
<div class="d-flex align-items-center mb-4 mt-3">
  <span class="fw-bold" style="color: #000; font-size: 20px;">Inicio</span>
  <span style="color: #888; margin: 0 8px; font-size: 20px;">/</span>
  <span class="fw-bold" style="color: #888; font-size: 20px;">Trabajos</span>
</div>

<!-- Botones de acción principales -->
<div class="d-flex gap-2 mb-4">
  <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newPresupuestoModal" style="border-radius: 1rem; border: 1px solid #cbc6c6; padding: 0.5rem 1.25rem; transition: all 0.3s ease;">
    <i class="bi bi-file-earmark-plus me-1"></i> Nuevo Presupuesto
  </button>
  <a href="{{ url_for('jobs.historial') }}" class="btn btn-outline-secondary" style="border-radius: 1rem; border: 1px solid #cbc6c6; padding: 0.5rem 1.25rem; transition: all 0.3s ease;">
    <i class="bi bi-clock-history me-1"></i> Ver Historial
  </a>
  <div class="ms-auto">
    <div class="input-group" style="border-radius: 1rem; overflow: hidden; border: 1px solid #cbc6c6;">
      <input type="text" class="form-control" placeholder="Buscar trabajo..." id="searchInput" style="border: none; border-radius: 1rem 0 0 1rem;">
      <button class="btn btn-outline-secondary" type="button" id="searchButton" style="border: none; background-color: #f8f9fa; border-radius: 0 1rem 1rem 0;">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
</div>

<!-- Formulario oculto para manejar los filtros -->
<form action="{{ url_for('jobs.trabajos') }}" method="GET" id="filtrosForm" style="display:none;">
  <input type="hidden" id="estado_oculto" name="estado" value="{{ request.args.get('estado', '') }}">
  <input type="hidden" id="fecha_inicio_oculto" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
  <input type="hidden" id="fecha_fin_oculto" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
</form>

<!-- Tarjeta de trabajos -->
<div class="card" style="border-radius: 1rem; border: 1px solid #cbc6c6; overflow: hidden;">  <div class="card-header d-flex align-items-center justify-content-between" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-list-task" style="font-size: 0.9rem; color: #6c757d;"></i>
      <span style="font-size: 0.9rem; color: #6c757d; font-weight: 500;">Trabajos Activos</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <!-- Filtro de Estado -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroEstadoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-funnel-fill me-1" style="color: #28a745;"></i>
          <span>Estado: {{ request.args.get('estado', 'Todos') }}</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end chart-period-menu" aria-labelledby="filtroEstadoDropdown">
          <li><a class="dropdown-item filter-estado" href="#" data-value=""><i class="bi bi-list-stars me-2"></i>Todos</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Pendiente"><i class="bi bi-hourglass me-2"></i>Pendiente</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="En Proceso"><i class="bi bi-gear-wide-connected me-2"></i>En Proceso</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Presupuesto"><i class="bi bi-file-earmark-text me-2"></i>Presupuesto</a></li>
          <li><a class="dropdown-item filter-estado" href="#" data-value="Completado"><i class="bi bi-check-circle me-2"></i>Completado</a></li>
        </ul>
      </div>
      
      <!-- Filtro de Fecha Inicio -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroFechaInicioDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-event me-1" style="color: #28a745;"></i>
          <span>Desde: {{ request.args.get('fecha_inicio', 'Cualquier fecha') }}</span>
        </button>
        <div class="dropdown-menu p-3 dropdown-menu-end" style="min-width: 300px;" aria-labelledby="filtroFechaInicioDropdown">
          <div class="mb-2">Fecha Inicio:</div>
          <input type="date" class="form-control" id="fecha_inicio_filter" value="{{ request.args.get('fecha_inicio', '') }}">
          <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-sm btn-green aplicar-fecha-inicio">Aplicar</button>
          </div>
        </div>
      </div>
      
      <!-- Filtro de Fecha Fin -->
      <div class="dropdown chart-filter-dropdown">
        <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="filtroFechaFinDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-event-fill me-1" style="color: #28a745;"></i>
          <span>Hasta: {{ request.args.get('fecha_fin', 'Cualquier fecha') }}</span>
        </button>
        <div class="dropdown-menu p-3 dropdown-menu-end" style="min-width: 300px;" aria-labelledby="filtroFechaFinDropdown">
          <div class="mb-2">Fecha Fin:</div>
          <input type="date" class="form-control" id="fecha_fin_filter" value="{{ request.args.get('fecha_fin', '') }}">
          <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-sm btn-green aplicar-fecha-fin">Aplicar</button>
          </div>
        </div>
      </div>
        <!-- Botón para limpiar filtros -->
      <a href="{{ url_for('jobs.trabajos') }}" class="btn btn-sm btn-outline-secondary chart-period-btn" style="border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
        <i class="bi bi-arrow-repeat me-1" style="color: #28a745;"></i>
        <span>Limpiar filtros</span>
      </a>
    </div>
  </div>
  <div class="card-body p-0">
    {% if trabajos %}
    <div class="table-responsive">
      <table class="table mb-0 dashboard-table" id="trabajosTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Estado</th>
            <th>Técnico</th>
            <th>Descripción</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>          {% for trabajo in trabajos %}
          <tr data-estado="{{ trabajo.estado }}" data-id="{{ trabajo.id }}" class="trabajo-row" style="cursor: pointer;">
            <td class="text-center">
              <span class="text-decoration-none">
                Nº_{{ trabajo.id }}
              </span>
            </td>
            <td>{{ trabajo.nombre_cliente }} {{ trabajo.apellido_cliente or '' }}</td>
            <td>{{ trabajo.fecha.strftime('%d/%m/%Y') }}</td>
            <td>{{ trabajo.hora }}</td>
            <td>
              <span class="badge rounded-pill 
                {% if trabajo.estado == 'Presupuesto' %}bg-secondary
                {% elif trabajo.estado == 'Pendiente' %}bg-warning
                {% elif trabajo.estado == 'En Proceso' %}bg-primary
                {% elif trabajo.estado == 'Completado' %}bg-success
                {% else %}bg-secondary{% endif %}">
                {{ trabajo.estado }}
              </span>
            </td>
            <td>
              {% if trabajo.technician %}
                {{ trabajo.technician.nombre }} {{ trabajo.technician.apellido or '' }}
              {% else %}
                <span class="text-muted">Sin asignar</span>
              {% endif %}
            </td>
            <td>
              <div class="text-truncate" style="max-width: 150px;" title="{{ trabajo.descripcion }}">
                {{ trabajo.descripcion }}
              </div>
            </td>            <td>
              <div class="d-flex gap-1 justify-content-center action-buttons-container">
                <!-- Botón para ver detalles -->
                <a href="{{ url_for('jobs.ver_trabajo', id=trabajo.id) }}" class="btn btn-sm btn-outline-secondary btn-action action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver detalles del trabajo">
                  <i class="bi bi-eye"></i>
                </a>
                
                <!-- Botón para aprobar presupuesto (solo si está en estado Presupuesto) -->
                {% if trabajo.estado == 'Presupuesto' %}
                <form method="POST" action="{{ url_for('jobs.aprobar_presupuesto', id=trabajo.id) }}" style="display: inline;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="btn btn-sm btn-success btn-action action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Aprobar presupuesto">
                    <i class="bi bi-check-circle"></i>
                  </button>
                </form>
                {% endif %}
                
                <!-- Botón para completar comprobante (solo si está En Proceso) -->
                {% if trabajo.estado == 'En Proceso' %}
                <a href="{{ url_for('jobs.completar_comprobante', id=trabajo.id) }}" class="btn btn-sm btn-info btn-action action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Completar comprobante de trabajo">
                  <i class="bi bi-file-earmark-text"></i>
                </a>
                {% endif %}                <!-- Botón para editar -->                <button class="btn btn-sm btn-warning editar-trabajo btn-action action-btn"                        data-bs-toggle="modal" 
                        data-bs-target="#editJobModal"
                        data-id="{{ trabajo.id }}"
                        data-nombre_cliente="{{ trabajo.nombre_cliente }}"
                        data-apellido_cliente="{{ trabajo.apellido_cliente }}"
                        data-telefono="{{ trabajo.telefono }}"
                        data-email="{{ trabajo.email }}"
                        data-direccion="{{ trabajo.direccion }}"
                        data-codigo_postal="{{ trabajo.codigo_postal }}"
                        data-descripcion="{{ trabajo.descripcion }}"
                        data-duracion="{{ trabajo.duracion }}"
                        data-fecha="{{ trabajo.fecha.strftime('%Y-%m-%d') }}"
                        data-hora="{{ trabajo.hora }}"
                        data-tecnico_id="{{ trabajo.technician_id or '' }}"
                        data-estado="{{ trabajo.estado }}"
                        data-cantidad="{{ trabajo.cantidad or '' }}"
                        data-tipo_plaga="{{ trabajo.tipo_plaga or '' }}"
                        data-bs-custom-class="tooltip-warning"
                        title="Editar trabajo">
                  <i class="bi bi-pencil-square"></i>
                </button>
                  <!-- Botón para eliminar -->
                <button class="btn btn-sm btn-danger confirm-delete-job btn-action action-btn"
                        data-id="{{ trabajo.id }}"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-bs-custom-class="tooltip-danger"
                        title="Eliminar trabajo">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <!-- Paginación -->
    <div class="d-flex justify-content-center" style="padding: 10px 0; margin-top: -1px; border-top: 1px solid #cbc6c6; background-color: #f9f9f9; border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
      <nav aria-label="Paginación de trabajos">
        <ul class="pagination m-0" style="gap: 0.5rem;">
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">&laquo;</span>
          </li>
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">&lt;</span>
          </li>
          <li class="page-item disabled">
            <span class="page-link minimal-pagination">1 / 3</span>
          </li>
          <li class="page-item">
            <a class="page-link minimal-pagination" href="#">&gt;</a>
          </li>
          <li class="page-item">
            <a class="page-link minimal-pagination" href="#">&raquo;</a>
          </li>
        </ul>
      </nav>
    </div>
    
    {% else %}
    <div class="alert alert-info m-3 text-center">
      <i class="bi bi-info-circle me-2"></i> No hay trabajos registrados.
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal para nuevo presupuesto -->
<div class="modal fade" id="newPresupuestoModal" tabindex="-1" aria-labelledby="newPresupuestoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
      <div class="modal-header" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; padding: 1.25rem;">
        <h5 class="modal-title" id="newPresupuestoModalLabel">
          <i class="bi bi-file-earmark-plus me-2 text-green"></i>Crear Nuevo Presupuesto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('jobs.crear_presupuesto') }}" id="addBudgetForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body p-4">
          <!-- Sección de Datos de Cliente -->
          <div class="mb-4 bg-light rounded p-3" style="border-left: 4px solid #28a745;">
            <h6 class="fw-bold text-green mb-3 d-flex align-items-center">
              <i class="bi bi-person-circle me-2"></i>Datos del Cliente
            </h6>
            <div class="row g-3 mb-3">
              <!-- Primera fila de datos del cliente -->
              <div class="col-lg-3 col-md-6">
                <label for="nombre_cliente" class="form-label">
                  <i class="bi bi-person-fill me-1 small text-muted"></i>Nombre:
                </label>
                <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" 
                       placeholder="Ingrese nombre" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="apellido_cliente" class="form-label">
                  <i class="bi bi-person-fill me-1 small text-muted"></i>Apellido:
                </label>
                <input type="text" class="form-control" id="apellido_cliente" name="apellido_cliente" 
                       placeholder="Ingrese apellido" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="telefono" class="form-label">
                  <i class="bi bi-telephone-fill me-1 small text-muted"></i>Teléfono:
                </label>
                <input type="tel" class="form-control" id="telefono" name="telefono" 
                       placeholder="Ej: 612345678" 
                       pattern="^(?:\+34[\s-]?)?(?:\d{3}[\s.-]?\d{3}[\s.-]?\d{3})$"
                       title="Formato: +34 123456789 o 123-456-789"
                       required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="email" class="form-label">
                  <i class="bi bi-envelope-fill me-1 small text-muted"></i>Email:
                </label>
                <input type="email" class="form-control" id="email" name="email" 
                       placeholder="email@ejemplo.com" required style="border-radius: 0.5rem;">
              </div>
            </div>
            
            <!-- Segunda fila de datos del cliente -->
            <div class="row g-3">
              <div class="col-lg-5 col-md-4">
                <label for="direccion" class="form-label">
                  <i class="bi bi-geo-alt-fill me-1 small text-muted"></i>Dirección:
                </label>
                <input type="text" class="form-control" id="direccion" name="direccion" 
                       placeholder="Ingrese dirección completa" style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-2 col-md-2">
                <label for="codigo_postal" class="form-label">
                  <i class="bi bi-mailbox me-1 small text-muted"></i>C.P.:
                </label>
                <input type="text" class="form-control" id="codigo_postal" name="codigo_postal" 
                       placeholder="Ej: 28001" style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-4">
                <label for="dni_cif" class="form-label">
                  <i class="bi bi-card-text me-1 small text-muted"></i>DNI/NIE/CIF:
                </label>
                <input type="text" class="form-control" id="dni_cif" name="dni_cif" 
                       placeholder="Para facturación" style="border-radius: 0.5rem;">
                <div class="form-text small text-muted">
                  <i class="bi bi-info-circle me-1"></i>Necesario para facturación
                </div>
              </div>
              <div class="col-lg-2 col-md-2">
                <label for="tipo_documento" class="form-label">
                  <i class="bi bi-card-checklist me-1 small text-muted"></i>Tipo:
                </label>
                <select class="form-select" id="tipo_documento" name="tipo_documento" style="border-radius: 0.5rem;">
                  <option value="dni">DNI</option>
                  <option value="nie">NIE</option>
                  <option value="cif">CIF</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Sección de Detalles del Trabajo -->
          <div class="mb-4 bg-light rounded p-3" style="border-left: 4px solid #28a745;">
            <h6 class="fw-bold text-green mb-3 d-flex align-items-center">
              <i class="bi bi-tools me-2"></i>Detalles del Trabajo
            </h6>
            
            <!-- Descripción del trabajo -->
            <div class="row mb-4">
              <div class="col-12">
                <label for="descripcion" class="form-label">
                  <i class="bi bi-file-text-fill me-1 small text-muted"></i>Descripción del Trabajo:
                </label>                <textarea class="form-control" id="descripcion" name="descripcion" rows="2" 
                  placeholder="Ingrese una descripción detallada del trabajo a realizar..." 
                  required style="border-radius: 0.5rem;"></textarea>
              </div>
            </div>
            
            <!-- Detalles de programación y costos -->
            <div class="row g-3">
              <div class="col-md-3 col-sm-6">
                <label for="fecha" class="form-label">
                  <i class="bi bi-calendar-date me-1 small text-muted"></i>Fecha:
                </label>
                <input type="date" class="form-control" id="fecha" name="fecha" style="border-radius: 0.5rem;">
                <div class="form-text small text-muted">
                  <i class="bi bi-calendar3 me-1"></i>Día programado
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="hora" class="form-label">
                  <i class="bi bi-clock me-1 small text-muted"></i>Hora:
                </label>
                <input type="time" class="form-control" id="hora" name="hora" style="border-radius: 0.5rem;">
                <div class="form-text small text-muted">
                  <i class="bi bi-clock me-1"></i>Hora programada
                </div>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="duracion" class="form-label">
                  <i class="bi bi-hourglass-split me-1 small text-muted"></i>Duración:
                </label>
                <select class="form-select" id="duracion" name="duracion" style="border-radius: 0.5rem;" required>
                  <option value="corta">Corta (1 hora)</option>
                  <option value="media" selected>Media (2 horas)</option>
                  <option value="larga">Larga (3 horas)</option>
                </select>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="cantidad" class="form-label">
                  <i class="bi bi-currency-euro me-1 small text-muted"></i>Importe:
                </label>
                <div class="input-group" style="border-radius: 0.5rem; overflow: hidden;">
                  <input type="number" class="form-control" id="cantidad" name="cantidad" step="0.01" min="0" 
                         placeholder="0.00" required style="border-radius: 0.5rem 0 0 0.5rem;">
                  <span class="input-group-text" style="border-radius: 0 0.5rem 0.5rem 0;">€</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sección de Tipo de Plaga -->
          <div class="bg-light rounded p-3" style="border-left: 4px solid #28a745;">
            <h6 class="fw-bold text-green mb-3 d-flex align-items-center">
              <i class="bi bi-bug me-2"></i>Información de Plaga
            </h6>
            <div class="row">
              <div class="col-12">
                <label for="tipo_plaga" class="form-label">
                  <i class="bi bi-bug-fill me-1 small text-muted"></i>Tipo de Plaga:
                </label>
                <select class="form-select" id="tipo_plaga" name="tipo_plaga" style="border-radius: 0.5rem;">
                  <option value="">Seleccione tipo de plaga</option>
                  <option value="Cucaracha Americana (Periplaneta Americana)">Cucaracha Americana (Periplaneta Americana)</option>
                  <option value="Cucaracha Alemana (Blatella Germanica)">Cucaracha Alemana (Blatella Germanica)</option>
                  <option value="Rata Campo (Rattus Rattus)">Rata Campo (Rattus Rattus)</option>
                  <option value="Rata Alcantarilla (Rattus Norvegicus)">Rata Alcantarilla (Rattus Norvegicus)</option>
                  <option value="Ratón Común (Mus Musculus)">Ratón Común (Mus Musculus)</option>
                  <option value="Hormiga Común (Lasius Niger)">Hormiga Común (Lasius Niger)</option>
                  <option value="Chinche Cama (Cimex Lectularius)">Chinche Cama (Cimex Lectularius)</option>
                  <option value="Moscas, Mosquitos (Dípteros)">Moscas, Mosquitos (Dípteros)</option>
                </select>
                <div class="form-text small text-muted">
                  <i class="bi bi-info-circle me-1"></i>Seleccione para servicios de control de plagas
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background-color: #f9f9f9; border-top: 1px solid #cbc6c6; padding: 1rem 1.5rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 0.75rem; padding: 0.5rem 1.25rem; transition: all 0.3s ease; border: 1px solid #cbc6c6;">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-green" id="submitPresupuesto" style="border-radius: 0.75rem; border: 1px solid #28a745; padding: 0.5rem 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: all 0.3s ease;">
            <i class="bi bi-file-earmark-plus me-1"></i><span id="submitText">Generar y Enviar Presupuesto</span>
            <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar trabajo -->
<div class="modal fade" id="editJobModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <form id="editJobForm" method="POST" action="" class="needs-validation" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="modal-content" style="border-radius: 1rem; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);">
        <div class="modal-header" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; padding: 1.25rem;">
          <h5 class="modal-title" id="editJobModalLabel">
            <i class="bi bi-pencil-square me-2 text-primary"></i>Editar Trabajo
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <!-- Sección de Datos de Cliente -->
          <div class="mb-4 bg-light rounded p-3" style="border-left: 4px solid #0d6efd;">
            <h6 class="fw-bold text-primary mb-3 d-flex align-items-center">
              <i class="bi bi-person-circle me-2"></i>Datos del Cliente
            </h6>
            <div class="row g-3 mb-3">
              <!-- Primera fila de datos del cliente -->
              <div class="col-lg-4 col-md-6">
                <label for="modalNombreCliente" class="form-label">
                  <i class="bi bi-person-fill me-1 small text-muted"></i>Nombre:
                </label>
                <input type="text" class="form-control" id="modalNombreCliente" name="nombre_cliente" 
                       required style="border-radius: 0.5rem;">
              </div>              <div class="col-lg-4 col-md-6">
                <label for="modalApellidoCliente" class="form-label">
                  <i class="bi bi-person-fill me-1 small text-muted"></i>Apellido:
                </label>
                <input type="text" class="form-control" id="modalApellidoCliente" name="apellido_cliente" 
                       style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-4 col-md-6">
                <label for="modalTelefono" class="form-label">
                  <i class="bi bi-telephone-fill me-1 small text-muted"></i>Teléfono:
                </label>
                <input type="text" class="form-control" id="modalTelefono" name="telefono"
                      pattern="^(?:\+34[\s-]?)?(?:\d{3}[\s.-]?\d{3}[\s.-]?\d{3})$"
                      title="Formato: +34 123456789 o 123-456-789"
                      maxlength="15" style="border-radius: 0.5rem;">
                <div id="telefono-error" class="invalid-feedback">
                  Formato de teléfono inválido
                </div>
              </div>
              <div class="col-lg-4 col-md-6">
                <label for="modalEmail" class="form-label">
                  <i class="bi bi-envelope-fill me-1 small text-muted"></i>Email:
                </label>
                <input type="email" class="form-control" id="modalEmail" name="email" 
                       placeholder="email@ejemplo.com" style="border-radius: 0.5rem;">
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-lg-8 col-md-8">
                <label for="modalDireccion" class="form-label">
                  <i class="bi bi-geo-alt-fill me-1 small text-muted"></i>Dirección:
                </label>
                <input type="text" class="form-control" id="modalDireccion" name="direccion" 
                       required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-4 col-md-4">
                <label for="modalCodigoPostal" class="form-label">
                  <i class="bi bi-mailbox me-1 small text-muted"></i>Código Postal:
                </label>
                <input type="text" class="form-control" id="modalCodigoPostal" name="codigo_postal" 
                       style="border-radius: 0.5rem;">
              </div>
            </div>
          </div>
            <!-- Sección de Detalles del Trabajo -->
          <div class="mb-4 bg-light rounded p-3" style="border-left: 4px solid #0d6efd;">
            <h6 class="fw-bold text-primary mb-3 d-flex align-items-center">
              <i class="bi bi-tools me-2"></i>Detalles del Trabajo
            </h6>
            <div class="row mb-4">
              <div class="col-12">                <label for="modalDescripcion" class="form-label">
                  <i class="bi bi-file-text-fill me-1 small text-muted"></i>Descripción:
                </label>
                <textarea class="form-control" id="modalDescripcion" name="descripcion" rows="2" required style="border-radius: 0.5rem;"></textarea>
              </div>
            </div>
          
            <div class="row g-3 mb-4">
              <div class="col-lg-3 col-md-6">
                <label for="modalFecha" class="form-label">
                  <i class="bi bi-calendar-date me-1 small text-muted"></i>Fecha:
                </label>
                <input type="date" class="form-control" id="modalFecha" name="fecha" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="modalHora" class="form-label">
                  <i class="bi bi-clock me-1 small text-muted"></i>Hora:
                </label>
                <input type="time" class="form-control" id="modalHora" name="hora" required style="border-radius: 0.5rem;">
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="modalDuracion" class="form-label">
                  <i class="bi bi-hourglass-split me-1 small text-muted"></i>Duración:
                </label>
                <select class="form-select" id="modalDuracion" name="duracion" style="border-radius: 0.5rem;">
                  <option value="corta">Corta (1 hora)</option>
                  <option value="media">Media (2 horas)</option>
                  <option value="larga">Larga (3 horas)</option>
                </select>
              </div>
              <div class="col-lg-3 col-md-6">
                <label for="modalCantidad" class="form-label">Importe (€):</label>
                <div class="input-group" style="border-radius: 0.5rem; overflow: hidden;">
                  <input type="number" class="form-control" id="modalCantidad" name="cantidad" step="0.01" min="0" placeholder="0.00" style="border-radius: 0.5rem 0 0 0.5rem;">
                  <span class="input-group-text" style="border-radius: 0 0.5rem 0.5rem 0;">€</span>
                </div>
              </div>
            </div>
            
            <div class="row g-3 mb-4">              
              <div class="col-lg-6 col-md-6">                
                <label for="modalTecnicoId" class="form-label">
                  <i class="bi bi-person-badge me-1 small text-muted"></i>Técnico Asignado:
                </label>
                <select class="form-select" id="modalTecnicoId" name="tecnico_id" style="border-radius: 0.5rem;">
                  <option value="">Sin asignar</option>
                  {% for tecnico in tecnicos %}
                  <option value="{{ tecnico.id }}">
                    {{ tecnico.nombre }} {% if tecnico.apellido %}{{ tecnico.apellido }}{% endif %}
                  </option>
                  {% endfor %}
                </select>
                <div class="form-text small text-muted">
                  {% if tecnicos %}
                    <i class="bi bi-info-circle me-1"></i>Solo se muestran técnicos disponibles
                  {% else %}
                    <span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>No hay técnicos disponibles en este momento</span>
                  {% endif %}
                </div>
              </div>
              <div class="col-lg-6 col-md-6">
                <label for="modalEstado" class="form-label">
                  <i class="bi bi-clipboard-check me-1 small text-muted"></i>Estado del Trabajo:
                </label>
                <select class="form-select" id="modalEstado" name="estado" style="border-radius: 0.5rem;">
                  <option value="Presupuesto">Presupuesto</option>
                  <option value="Pendiente">Pendiente</option>
                  <option value="En Proceso">En Proceso</option>
                  <option value="Completado">Completado</option>
                </select>
                <div class="form-text small text-muted">
                  <i class="bi bi-info-circle me-1"></i>Indica el progreso actual del trabajo
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sección de Tipo de Plaga -->
          <div class="bg-light rounded p-3" style="border-left: 4px solid #0d6efd;">
            <h6 class="fw-bold text-primary mb-3 d-flex align-items-center">
              <i class="bi bi-bug me-2"></i>Información de Plaga
            </h6>
            <div class="row">
              <div class="col-12">
                <label for="modalTipoPlaga" class="form-label">
                  <i class="bi bi-bug-fill me-1 small text-muted"></i>Tipo de Plaga:
                </label>
                <select class="form-select" id="modalTipoPlaga" name="tipo_plaga" style="border-radius: 0.5rem;">
                  <option value="">Seleccione tipo de plaga</option>
                  <option value="Cucaracha Americana (Periplaneta Americana)">Cucaracha Americana (Periplaneta Americana)</option>
                  <option value="Cucaracha Alemana (Blatella Germanica)">Cucaracha Alemana (Blatella Germanica)</option>
                  <option value="Rata Campo (Rattus Rattus)">Rata Campo (Rattus Rattus)</option>
                  <option value="Rata Alcantarilla (Rattus Norvegicus)">Rata Alcantarilla (Rattus Norvegicus)</option>
                  <option value="Ratón Común (Mus Musculus)">Ratón Común (Mus Musculus)</option>
                  <option value="Hormiga Común (Lasius Niger)">Hormiga Común (Lasius Niger)</option>
                  <option value="Chinche Cama (Cimex Lectularius)">Chinche Cama (Cimex Lectularius)</option>
                  <option value="Moscas, Mosquitos (Dípteros)">Moscas, Mosquitos (Dípteros)</option>
                </select>
                <small class="form-text text-muted">
                  <i class="bi bi-bug me-1"></i>Seleccione para servicios de control de plagas
                </small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background-color: #f9f9f9; border-top: 1px solid #cbc6c6; padding: 1rem 1.5rem;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 0.75rem; padding: 0.5rem 1.25rem; transition: all 0.3s ease; border: 1px solid #cbc6c6;">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="editJobSubmit" style="border-radius: 0.75rem; padding: 0.5rem 1.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: all 0.3s ease;">
            <i class="bi bi-save me-1"></i><span>Guardar Cambios</span>
            <span id="editLoadingSpinner" class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;"></span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal para confirmar eliminación de trabajo -->
{% from "components/modals.html" import confirm_modal %}

{{ confirm_modal(
    id="confirmDeleteModal",
    title="Confirmar Eliminación",
    message="¿Estás seguro de que deseas eliminar este trabajo? Esta acción no se puede deshacer.",
    action_url="",
    confirm_text="Eliminar",
    cancel_text="Cancelar"
) }}
{% endblock %}

{% block extra_scripts %}
<script>  document.addEventListener('DOMContentLoaded', function() {
    // Añadir atributos para tooltips a los botones que no los tienen
    document.querySelectorAll('.action-btn').forEach(function(btn) {
      if (!btn.getAttribute('title')) {
        // Determinar el tipo de botón por su icono o clase
        if (btn.querySelector('.bi-eye')) {
          btn.setAttribute('title', 'Ver detalles del trabajo');
        } else if (btn.querySelector('.bi-pencil-square')) {
          btn.setAttribute('title', 'Editar trabajo');
        } else if (btn.querySelector('.bi-trash')) {
          btn.setAttribute('title', 'Eliminar trabajo');
        } else if (btn.querySelector('.bi-check-circle')) {
          btn.setAttribute('title', 'Aprobar presupuesto');
        } else if (btn.querySelector('.bi-file-earmark-text')) {
          btn.setAttribute('title', 'Completar comprobante de trabajo');
        }
      }
    });
    
    // Inicializar tooltips para todos los elementos con título
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('.action-btn[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl, {
        trigger: 'hover',
        placement: 'top',
        delay: { show: 300, hide: 100 }
      });
    });
    
    // Configuración del formulario de presupuesto
    const addBudgetForm = document.getElementById('addBudgetForm');
    if (addBudgetForm) {
      addBudgetForm.addEventListener('submit', function(e) {
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        
        // Si uno está lleno y el otro vacío, solicitar completar ambos
        if ((fechaInput.value && !horaInput.value) || (!fechaInput.value && horaInput.value)) {
          e.preventDefault();
          alert('Por favor, complete tanto la fecha como la hora, o deje ambos campos vacíos para asignación automática.');
          return;
        }
        
        // Mostrar animación de carga
        const submitButton = document.getElementById('submitPresupuesto');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const submitText = document.getElementById('submitText');
        
        if (submitButton && loadingSpinner && submitText) {
          submitButton.disabled = true;
          loadingSpinner.style.display = 'inline-block';
          submitText.textContent = 'Procesando...';
        }
      });
    }
    
    // Configuración del formulario de edición de trabajo
    const editJobForm = document.getElementById('editJobForm');
    if (editJobForm) {
      editJobForm.addEventListener('submit', function(e) {
        const submitButton = document.getElementById('editJobSubmit');
        const loadingSpinner = document.getElementById('editLoadingSpinner');
        
        if (submitButton && loadingSpinner) {
          submitButton.disabled = true;
          loadingSpinner.style.display = 'inline-block';
          submitButton.querySelector('span').textContent = 'Guardando...';
        }
      });
    }
    
    // Configurar modal de eliminación
    const deleteButtons = document.querySelectorAll('.confirm-delete-job');
    deleteButtons.forEach(button => {
      button.addEventListener('click', function() {
        const jobId = this.getAttribute('data-id');
        const form = document.querySelector('#confirmDeleteModal form');
        form.action = `{{ url_for('jobs.eliminar_trabajo', id=0) }}`.replace('0', jobId);
      });
    });
      // Manejo de filtros en la cabecera
    const filtrosForm = document.getElementById('filtrosForm');
    const estadoOcultoInput = document.getElementById('estado_oculto');
    const fechaInicioOcultoInput = document.getElementById('fecha_inicio_oculto');
    const fechaFinOcultoInput = document.getElementById('fecha_fin_oculto');
    
    // Filtrado por estado con nuevo dropdown
    document.querySelectorAll('.filter-estado').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const estadoValor = this.getAttribute('data-value');
        
        // Actualizar campo oculto
        estadoOcultoInput.value = estadoValor;
        
        // Enviar formulario automáticamente
        filtrosForm.submit();
      });
    });
    
    // Filtrado por fecha de inicio
    document.querySelector('.aplicar-fecha-inicio').addEventListener('click', function() {
      const fechaInicioValor = document.getElementById('fecha_inicio_filter').value;
      
      // Actualizar campo oculto
      fechaInicioOcultoInput.value = fechaInicioValor;
      
      // Enviar formulario automáticamente
      filtrosForm.submit();
    });
    
    // Filtrado por fecha de fin
    document.querySelector('.aplicar-fecha-fin').addEventListener('click', function() {
      const fechaFinValor = document.getElementById('fecha_fin_filter').value;
      
      // Actualizar campo oculto
      fechaFinOcultoInput.value = fechaFinValor;
      
      // Enviar formulario automáticamente
      filtrosForm.submit();
    });
    
    // Función de búsqueda
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    
    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase();
      const rows = document.querySelectorAll('#trabajosTable tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    if (searchButton && searchInput) {
      searchButton.addEventListener('click', performSearch);
      searchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    }
    
    // Inicializar paginación
    // Código para paginar la tabla (15 trabajos por página)
    const table = document.getElementById('trabajosTable');
    if (table) {
      const rowsPerPage = 15;
      const rows = table.querySelectorAll('tbody tr');
      const pageCount = Math.ceil(rows.length / rowsPerPage);
      
      // Función para mostrar una página específica
      function showPage(pageNumber) {
        // Ocultar todas las filas
        rows.forEach(row => {
          row.style.display = 'none';
        });
        
        // Mostrar las filas de la página actual
        const start = (pageNumber - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        
        for (let i = start; i < end && i < rows.length; i++) {
          rows[i].style.display = '';
        }
        
        // Actualizar navegación de paginación
        updatePagination(pageNumber);
      }
      
      // Función para actualizar los controles de paginación
      function updatePagination(currentPage) {
        const pagination = document.querySelector('.pagination');
        if (pagination) {
          const pageLinks = pagination.querySelectorAll('span.page-link');
          if (pageLinks && pageLinks.length > 0) {
            const pageInfoSpan = pageLinks[2]; // El tercero es el que contiene la información de la página
            pageInfoSpan.textContent = `${currentPage} / ${pageCount}`;
          }
          
          // Actualizar estado de los botones siguiente/anterior
          const prevButton = pagination.querySelector('.page-item:nth-child(2)');
          const nextButton = pagination.querySelector('.page-item:nth-child(4)');
          
          if (prevButton) {
            if (currentPage <= 1) {
              prevButton.classList.add('disabled');
            } else {
              prevButton.classList.remove('disabled');
              const prevLink = prevButton.querySelector('a, span');
              if (prevLink.tagName === 'A') {
                prevLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(currentPage - 1);
                };
              }
            }
          }
          
          if (nextButton) {
            if (currentPage >= pageCount) {
              nextButton.classList.add('disabled');
            } else {
              nextButton.classList.remove('disabled');
              const nextLink = nextButton.querySelector('a, span');
              if (nextLink.tagName === 'A') {
                nextLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(currentPage + 1);
                };
              }
            }
          }
          
          // Actualizar primer y último botón
          const firstButton = pagination.querySelector('.page-item:first-child');
          const lastButton = pagination.querySelector('.page-item:last-child');
          
          if (firstButton) {
            if (currentPage <= 1) {
              firstButton.classList.add('disabled');
            } else {
              firstButton.classList.remove('disabled');
              const firstLink = firstButton.querySelector('a, span');
              if (firstLink.tagName === 'A') {
                firstLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(1);
                };
              }
            }
          }
          
          if (lastButton) {
            if (currentPage >= pageCount) {
              lastButton.classList.add('disabled');
            } else {
              lastButton.classList.remove('disabled');
              const lastLink = lastButton.querySelector('a, span');
              if (lastLink.tagName === 'A') {
                lastLink.onclick = function(e) {
                  e.preventDefault();
                  showPage(pageCount);
                };
              }
            }
          }
        }
      }
      
      // Si hay más de una página, inicializar la paginación
      if (pageCount > 1) {
        showPage(1);
        
        // Actualizar navegación inicial
        const pagination = document.querySelector('.pagination');
        if (pagination) {
          const pageLinks = pagination.querySelectorAll('.page-link');
          
          // Configurar los botones de navegación
          if (pageLinks.length >= 5) {
            pageLinks[0].onclick = function(e) {
              e.preventDefault();
              showPage(1);
            };
            
            pageLinks[1].onclick = function(e) {
              e.preventDefault();
              const currentPage = parseInt(pageLinks[2].textContent.split(' / ')[0]);
              if (currentPage > 1) {
                showPage(currentPage - 1);
              }
            };
            
            pageLinks[3].onclick = function(e) {
              e.preventDefault();
              const currentPage = parseInt(pageLinks[2].textContent.split(' / ')[0]);
              if (currentPage < pageCount) {
                showPage(currentPage + 1);
              }
            };
            
            pageLinks[4].onclick = function(e) {
              e.preventDefault();
              showPage(pageCount);
            };
          }
        }
      }
    }
  });
</script>

<style>
  /* Estilos mejorados para formularios y modales */
  .form-control, .form-select {
    border-radius: 0.5rem !important;
    border: 1px solid #cbc6c6;
    padding: 0.6rem 0.75rem;
    transition: all 0.2s ease-in-out;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }
  
  .modal-content {
    border: none;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
    .modal-header {
    border-bottom-color: #f0f0f0;
    padding: 0.85rem 1.25rem;
  }
  
  .modal-footer {
    border-top-color: #f0f0f0;
    padding: 0.85rem 1.25rem;
  }
  
  .modal-body {
    padding: 1rem 1.25rem;
  }
    .modal-xxl {
    max-width: 85%;
  }
  
  /* Hacer los modales más pequeños en general */
  .modal-dialog {
    max-width: 80%;
  }
  
  /* Estilos para secciones de formularios */
  .form-section {
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: #f9f9f9;
    margin-bottom: 1.5rem;
  }
  
  .form-section-title {
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
  }
  
  .form-label {
    font-weight: 500;
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0.5rem;
  }
  
  .form-text {
    font-size: 0.75rem;
  }
  
  /* Estilos para botones en modales */
  .btn-green {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
    transition: all 0.2s;
  }
  
  .btn-green:hover {
    background-color: #218838;
    border-color: #1e7e34;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  
  .modal-body .row {
    margin-bottom: 1rem;
  }
    /* Mejorar el espacio entre elementos de formulario */
  .modal-body .form-label {
    margin-bottom: 0.2rem;
    font-size: 0.85rem;
  }
  
  /* Reducir espacio entre filas del formulario */
  .modal-body .row {
    margin-bottom: 0.5rem;
  }
  
  /* Hacer los inputs y selects más pequeños */
  .form-control, .form-select {
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
  }
  
  /* Reducir espaciado en secciones del formulario */
  .mb-4 {
    margin-bottom: 0.75rem !important;
  }
  
  /* Ajustes para secciones con fondo */
  .bg-light.rounded.p-3 {
    padding: 0.75rem !important;
  }
  
  /* Mejora visual para los elementos con iconos */
  .input-group {
    box-shadow: none !important;
    transition: all 0.2s ease-in-out;
  }
  
  .input-group:focus-within {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
  }
  
  .input-group .form-control {
    border-right: 0;
  }
  
  .input-group .input-group-text {
    background-color: #f8f9fa;
    border-color: #cbc6c6;
  }
  
  /* Estilo para elementos requeridos */
  .form-control:required, .form-select:required {
    background-image: linear-gradient(45deg, transparent, transparent 50%, #dc3545 50%, transparent 51%);
    background-position: right 2px top 2px;
    background-size: 6px 6px;
    background-repeat: no-repeat;
  }
  
  /* Colores de tema */
  .text-green {
    color: #28a745 !important;
  }
  
  /* Mejoras en la tabla */
  .dashboard-table thead th {
    font-weight: 600;
    color: #495057;
    border-bottom-width: 1px;
  }
  
  .dashboard-table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.03);
  }
  
  .action-buttons-container {
    min-width: 120px;
  }
  
  /* Estilo para las secciones en formularios */
  .section-divider {
    height: 4px;
    width: 50px;
    background-color: #0d6efd;
    margin: 1rem 0;
    border-radius: 2px;
  }
</style>

<!-- Script para hacer las filas de la tabla clickeables -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Agregar estilo CSS para filas clickeables
    const style = document.createElement('style');
    style.textContent = `
      .trabajo-row {
        transition: background-color 0.15s ease-in-out;
      }
      .trabajo-row:hover {
        background-color: rgba(67, 171, 1, 0.05);
      }
    `;
    document.head.appendChild(style);
      // Hacer que las filas de la tabla sean clickeables
    document.querySelectorAll('.trabajo-row').forEach(row => {
      row.addEventListener('click', function(e) {
        // Evitar que el clic funcione si se hace en un botón o enlace dentro de la fila
        if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) {
          return;
        }
        
        // Obtener el ID del trabajo desde el atributo data-id
        const trabajoId = this.getAttribute('data-id');
        // Redirigir a la página de detalles del trabajo
        if (trabajoId) {
          window.location.href = '/jobs/' + trabajoId;
        }
      });    });
  });
</script>
{% endblock %}
