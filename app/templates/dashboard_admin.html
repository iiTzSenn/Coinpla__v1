{% extends 'base.html' %}
{% block title %}Dashboard - Admin{% endblock %}

{% block content %}
{% from "components/page_header.html" import page_header %}
{% from "components/dashboard_cards.html" import stats_row, chart_card %}

{{ page_header(
    title="",
    breadcrumbs=[
        {"text": "Inicio"}
    ]
) }}

<!-- Estad√≠sticas principales -->
<div class="row mb-4">
  <div class="col-md-3 mb-4">
    <div class="dashboard-card trabajos" data-icon="üõ†Ô∏è">
      <div class="card-body text-center">
        <h4 class="counter" data-target="{{ num_trabajos }}">0</h4>
        <p class="card-text">Trabajos Totales</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-4">
    <div class="dashboard-card pendientes" data-icon="‚è∞">
      <div class="card-body text-center">
        <h4 class="counter" data-target="{{ num_trabajos_pendientes }}">0</h4>
        <p class="card-text">Trabajos en Proceso</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-4">
    <div class="dashboard-card completados" data-icon="‚úî">
      <div class="card-body text-center">
        <h4 class="counter" data-target="{{ num_trabajos_completados }}">0</h4>
        <p class="card-text">Trabajos Completados</p>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-4">
    <div class="dashboard-card facturacion" data-icon="üí∞">
      <div class="card-body text-center">
        <!-- Usamos la suma directa de los datos mensuales que ya funcionan -->
        <h4 id="facturacion-total">Calculando...</h4>
        <p class="card-text">Facturaci√≥n Total (‚Ç¨)</p>
      </div>
    </div>
  </div>
</div>

<!-- Gr√°fico principal de l√≠neas -->
<div class="row" style="margin-bottom: 1.75rem;">
  <div class="col-12">
    <div class="card" style="border-radius: 1rem; border: 1px solid #cbc6c6;">
      <div class="card-header d-flex align-items-center justify-content-between" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-graph-up" style="font-size: 0.9rem; color: #6c757d;"></i>
          <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500;">Trabajos por Mes</span>
        </div>
        <div class="dropdown chart-filter-dropdown">
          <button class="btn btn-sm dropdown-toggle chart-period-btn" type="button" id="periodoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <span>√öltimos 3 meses</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end chart-period-menu" aria-labelledby="periodoDropdown">
            <li><a class="dropdown-item" href="#" onclick="filterChart(90); return false;"><i class="bi bi-calendar3 me-2"></i>√öltimos 3 meses</a></li>
            <li><a class="dropdown-item" href="#" onclick="filterChart(180); return false;"><i class="bi bi-calendar3-range me-2"></i>√öltimos 6 meses</a></li>
            <li><a class="dropdown-item" href="#" onclick="filterChart(365); return false;"><i class="bi bi-calendar3-fill me-2"></i>√öltimo a√±o</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="filterChart('max'); return false;"><i class="bi bi-infinity me-2"></i>Todo el historial</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <canvas id="trabajosLineChart" style="width: 100%; height: 200x;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gr√°ficos secundarios -->
<div class="row mb-4" style="margin-top: 1.75rem;">
  <div class="col-md-4 pe-md-3">
    <div class="card" style="border-radius: 1rem; border: 1px solid #cbc6c6; margin-left: 0; width: 100%;">
      <div class="card-header d-flex align-items-center gap-2" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <i class="bi bi-person-check" style="font-size: 0.9rem; color: #6c757d;"></i>
        <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500;">T√©cnicos y trabajos</span>
      </div>
      <div class="card-body d-flex justify-content-center">
        <div style="width: 100%; height: 200px; position: relative; max-width: 300px;">
          <canvas id="distribucionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8 ps-md-3">
    <div class="card" style="border-radius: 1rem; border: 1px solid #cbc6c6;">
      <div class="card-header d-flex align-items-center gap-2" style="background-color: #f9f9f9; border-bottom: 1px solid #cbc6c6; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <i class="bi bi-currency-dollar" style="font-size: 0.9rem; color: #6c757d;"></i>
        <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500;">Facturaci√≥n</span>
      </div>
      <div class="card-body">
        <canvas id="facturacionBarChart" style="width: 100%; height: 200px;"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  var mesesLabels = {{ meses_labels|default([])|tojson }};
  var trabajosMes = {{ trabajos_mes|default([])|tojson }};
  var facturacionMes = {{ facturacion_mes|default([])|tojson }};
  var trabajosPendientesMes = {{ trabajosPendientesMes|default([])|tojson }};
  var trabajosPendientes = {{ num_trabajos_pendientes|default(0)|tojson }};
  var trabajosEnProceso = {{ num_trabajos_en_proceso|default(0)|tojson }};
  var trabajosCompletados = {{ num_trabajos_completados|default(0)|tojson }};
  var datosTecnicos = {{ datos_tecnicos|default([])|tojson }};
  
  // Calcular facturaci√≥n total sumando los datos mensuales
  document.addEventListener('DOMContentLoaded', function() {
    // Calcular la suma total de facturaci√≥n mensual
    const facturacionTotal = facturacionMes.reduce((total, valor) => total + valor, 0);
    
    // Actualizar el elemento visual con formato de 2 decimales
    const facturacionElement = document.getElementById('facturacion-total');
    if (facturacionElement) {
      facturacionElement.innerText = facturacionTotal.toLocaleString(undefined, { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }) + ' ‚Ç¨';
    }
  });
</script>
{% endblock %}
