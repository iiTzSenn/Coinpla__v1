{% extends 'base.html' %}
{% block title %}Dashboard Administrador - Coinpla{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">Dashboard Administrador</h2>
  
  <!-- Tarjetas de resumen -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card dashboard-card bg-primary usuarios">
        <div class="card-body">
          <h5 class="card-title">Usuarios</h5>
          <p class="card-text fs-4">{{ total_usuarios }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card dashboard-card bg-success trabajos">
        <div class="card-body">
          <h5 class="card-title">Trabajos Totales</h5>
          <p class="card-text fs-4">{{ total_trabajos }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card dashboard-card bg-warning pendientes">
        <div class="card-body">
          <h5 class="card-title">Pendientes</h5>
          <p class="card-text fs-4">{{ trabajos_pendientes }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card dashboard-card bg-danger completados">
        <div class="card-body">
          <h5 class="card-title">Completados</h5>
          <p class="card-text fs-4">{{ trabajos_completados }}</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Gráfico de Trabajos por Mes -->
  <div class="row mb-4">
    <div class="col-12">
      <canvas id="trabajosChart"></canvas>
    </div>
  </div>
  
  <!-- Calendario de Eventos -->
  <div class="row mb-4">
    <div class="col-12">
      <div id="calendar"></div>
    </div>
  </div>
  
  <!-- Lista de trabajos recientes -->
  <h4 class="mb-3">Trabajos Recientes</h4>
  {% if trabajos_recientes %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Técnico</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for trabajo in trabajos_recientes %}
          <tr>
            <td>{{ trabajo.nombre_cliente }} {% if trabajo.apellido_cliente %}{{ trabajo.apellido_cliente }}{% endif %}</td>
            <td>{{ trabajo.fecha.strftime('%d/%m/%Y') }}</td>
            <td>{{ trabajo.estado }}</td>
            <td>
              {% if trabajo.technician %}
                {{ trabajo.technician.nombre }} {% if trabajo.technician.apellido %}{{ trabajo.technician.apellido }}{% endif %}
              {% else %}
                Sin asignar
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('jobs.ver_trabajo', id=trabajo.id) }}" class="btn btn-sm btn-outline-primary">Ver Detalles</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info text-center mt-4">
      <i class="bi bi-info-circle"></i> No hay trabajos recientes.
    </div>
  {% endif %}
</div>

<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Incluir FullCalendar -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Gráfico de Chart.js - Trabajos por Mes
  const ctx = document.getElementById('trabajosChart').getContext('2d');
  const trabajosChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ meses_labels|tojson }},
      datasets: [{
        label: 'Trabajos',
        data: {{ trabajos_mes|tojson }},
        backgroundColor: 'rgba(78, 115, 223, 0.5)',
        borderColor: 'rgba(78, 115, 223, 1)',
        borderWidth: 1,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Calendario con FullCalendar
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: {{ eventos_calendario|tojson }},
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'  // ← corregido
    }
  });
  calendar.render();
});
</script>
{% endblock %}